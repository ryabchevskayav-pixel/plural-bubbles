<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plural Bubbles Ultimate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@400;700&family=Fredoka+One&family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg1: #0b1020;
            --bg2: #111a33;
            --card: rgba(15, 23, 48, 0.85);
            --text: #eef2ff;
            --good: #34d399;
            --bad: #fb7185;
            --blue: #60a5fa;
            --shadow: 0 18px 50px rgba(0,0,0,.35);
        }

        body {
            font-family: 'Comfortaa', cursive;
            background: radial-gradient(1200px 700px at 30% 20%, #20306a 0%, transparent 55%),
                        linear-gradient(180deg, var(--bg1), var(--bg2));
            color: var(--text);
            margin: 0;
            min-height: 100vh;
            overflow-x: hidden;
            overflow-y: auto; 
        }

        .glass {
            background: var(--card);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 24px;
            box-shadow: var(--shadow);
        }

        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 15px rgba(59, 130, 246, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        .pulse { animation: pulse 2s infinite; }

        .bubble {
            position: absolute;
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.2), transparent);
            border: 1px solid rgba(255,255,255,0.1);
            transition: transform 0.1s;
            z-index: 10;
        }
        .bubble img { width: 80%; height: 80%; object-fit: contain; }

        .switch { position: relative; display: inline-block; width: 50px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #334155; transition: .4s; border-radius: 34px;
        }
        .slider:before {
            position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px;
            background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--bad); }
        input:checked + .slider:before { transform: translateX(26px); }

        .crosshair { cursor: crosshair !important; }
        
        .progress-container { width: 100%; height: 12px; background: rgba(255,255,255,0.1); border-radius: 6px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--good), var(--blue)); transition: width 0.3s ease; }

        .toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            padding: 12px 24px; border-radius: 12px; background: var(--good);
            color: black; font-weight: bold; z-index: 2000; animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp { from { bottom: -50px; opacity: 0; } to { bottom: 20px; opacity: 1; } }

        #editor-screen {
            min-height: 100vh;
            padding-top: 2rem;
            padding-bottom: 2rem;
        }
    </style>
</head>
<body>

    <!-- EDITOR SCREEN -->
    <div id="editor-screen" class="w-full flex flex-col items-center justify-center">
        <div class="glass p-6 md:p-8 max-w-5xl w-[95%] grid grid-cols-1 md:grid-cols-2 gap-8">
            <div class="space-y-6">
                <h1 class="text-3xl font-bold text-blue-400">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ú–∏—Ä–∞</h1>
                
                <div class="space-y-4">
                    <label class="block text-sm opacity-60">–õ–æ–∫–∞—Ü–∏—è –∏ –ê—Ç–º–æ—Å—Ñ–µ—Ä–∞:</label>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="setTheme('underwater')" class="p-4 bg-white/5 rounded-2xl hover:bg-white/10 border border-white/5 transition flex flex-col items-center gap-2">
                            <span class="text-2xl">üåä</span> <span class="text-xs">–û–∫–µ–∞–Ω</span>
                        </button>
                        <button onclick="setTheme('space')" class="p-4 bg-white/5 rounded-2xl hover:bg-white/10 border border-white/5 transition flex flex-col items-center gap-2">
                            <span class="text-2xl">üåå</span> <span class="text-xs">–ö–æ—Å–º–æ—Å</span>
                        </button>
                        <button onclick="setTheme('forest')" class="p-4 bg-white/5 rounded-2xl hover:bg-white/10 border border-white/5 transition flex flex-col items-center gap-2">
                            <span class="text-2xl">üå≤</span> <span class="text-xs">–õ–µ—Å</span>
                        </button>
                        <button onclick="setTheme('cats')" class="p-4 bg-white/5 rounded-2xl hover:bg-white/10 border border-white/5 transition flex flex-col items-center gap-2">
                            <span class="text-2xl">üê±</span> <span class="text-xs">–ö–æ—Ç–∏–∫–∏</span>
                        </button>
                    </div>
                </div>

                <div class="flex items-center justify-between p-5 bg-black/20 rounded-2xl border border-white/5">
                    <div>
                        <span id="mode-label" class="block font-bold">–†–µ–∂–∏–º: –¢–∞–ø–∞–Ω–∏–µ ü´ß</span>
                        <span id="audio-desc" class="text-[10px] opacity-50 uppercase tracking-widest">–ú—è–≥–∫–∞—è –æ–∑–≤—É—á–∫–∞</span>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="mode-toggle" onchange="updateMode()">
                        <span class="slider"></span>
                    </label>
                </div>

                <div class="space-y-2">
                    <label class="block text-sm opacity-60">–°–≤–æ–π –ø—Ä–µ–¥–º–µ—Ç (URL –∫–∞—Ä—Ç–∏–Ω–∫–∏):</label>
                    <input type="text" id="custom-img" placeholder="https://example.com/item.png" 
                           class="w-full bg-black/40 border border-white/10 p-4 rounded-xl text-sm focus:border-blue-500 outline-none transition">
                </div>
            </div>

            <div class="flex flex-col gap-6">
                <div id="preview-box" class="w-full aspect-video rounded-3xl bg-cover bg-center border-2 border-white/10 relative flex items-center justify-center overflow-hidden shadow-2xl">
                    <div id="instruction-modal" class="glass p-6 text-center m-4 z-20 transition-all duration-500 shadow-2xl">
                        <div class="text-5xl mb-3">üéÆ</div>
                        <h2 class="text-2xl font-bold mb-3">–ö–∞–∫ –∏–≥—Ä–∞—Ç—å?</h2>
                        <p class="text-sm opacity-90 mb-6 leading-relaxed">–°–ª—É—à–∞–π —Å–ª–æ–≤–æ –∏ –Ω–∞–∂–∏–º–∞–π –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ª–µ—Ç–∞—é—â–∏–π –ø—Ä–µ–¥–º–µ—Ç. –ü—Ä–æ–π–¥–∏ –≤—Å–µ 4 —É—Ä–æ–≤–Ω—è!</p>
                        <button onclick="dismissInstruction()" class="w-full bg-blue-500 hover:bg-blue-600 py-3 rounded-xl font-bold text-lg transition-all active:scale-95 shadow-lg">–ü–û–ù–Ø–¢–ù–û!</button>
                    </div>
                    <span class="absolute top-4 right-4 bg-black/60 text-[10px] px-3 py-1 rounded-full border border-white/10">–ü–†–ï–í–¨–Æ</span>
                </div>
                
                <button id="start-btn" onclick="startGame()" disabled class="w-full py-5 rounded-2xl bg-gradient-to-r from-blue-600 to-indigo-600 font-bold text-2xl shadow-xl opacity-40 cursor-not-allowed transition-all hover:brightness-110">
                    –ù–ê–ß–ê–¢–¨ –ò–ì–†–£ üöÄ
                </button>
            </div>
        </div>
    </div>

    <!-- GAME SCREEN -->
    <div id="game-screen" class="fixed inset-0 hidden z-50">
        <div id="game-bg" class="absolute inset-0 bg-cover bg-center"></div>
        
        <!-- Game UI -->
        <div class="absolute top-0 left-0 right-0 p-4 md:p-8 flex justify-between items-start pointer-events-none z-[60]">
            <div class="space-y-3 pointer-events-auto">
                <button onclick="returnToEditor()" class="bg-white/10 hover:bg-white/20 backdrop-blur-md px-5 py-2 rounded-full text-sm font-bold border border-white/10 transition shadow-lg">‚Ü© –†–µ–¥–∞–∫—Ç–æ—Ä</button>
                <div class="flex items-center space-x-4 glass px-6 py-4">
                    <div>
                        <div class="text-[10px] opacity-60 uppercase font-bold tracking-widest">–£—Ä–æ–≤–µ–Ω—å <span id="level-num">1</span></div>
                        <div class="text-lg font-bold" id="level-name">–û–±—É—á–∞—é—â–∏–π</div>
                    </div>
                    <div class="h-10 w-[1px] bg-white/10"></div>
                    <div class="text-3xl font-bold text-blue-400" id="game-score">0</div>
                </div>
            </div>

            <div class="w-48 md:w-72 glass p-4 pointer-events-auto">
                <div class="flex justify-between text-[10px] font-bold uppercase mb-2 opacity-70">
                    <span>–ü—Ä–æ–≥—Ä–µ—Å—Å —É—Ä–æ–≤–Ω—è</span>
                    <span id="progress-percent">0%</span>
                </div>
                <div class="progress-container">
                    <div id="progress-bar" class="progress-fill" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- Target Word Display -->
        <div id="target-display" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 pointer-events-none text-center z-50">
            <h2 id="target-word" class="text-7xl md:text-9xl font-black drop-shadow-2xl tracking-tighter">...</h2>
            <div id="target-hint" class="inline-block mt-4 bg-white/10 backdrop-blur-md border border-white/20 rounded-full px-8 py-2 text-lg font-bold shadow-xl">–°–ª—É—à–∞–π –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ! üéß</div>
        </div>

        <div id="bubbles-container" class="absolute inset-0 z-40"></div>
    </div>

    <script>
        const themes = {
            underwater: { bg: 'url(https://images.unsplash.com/photo-1551244072-5d12893278ab?auto=format&fit=crop&w=1200)', items: ['ü´ß', 'üê≥', 'üê†'] },
            space: { bg: 'url(https://images.unsplash.com/photo-1475274047050-1d0c0975c63e?auto=format&fit=crop&w=1200)', items: ['üç©', 'üöÄ', 'üëΩ'] },
            forest: { bg: 'url(https://images.unsplash.com/photo-1441974231531-c6227db76b6e?auto=format&fit=crop&w=1200)', items: ['üçÑ', 'üå≤', 'ü•ñ'] },
            cats: { bg: 'url(https://images.unsplash.com/photo-1514888286974-6c03e2ca1dba?auto=format&fit=crop&w=1200)', items: ['üê±', 'üçî', 'üêæ'] }
        };

        const levels = [
            { id: 1, name: "–û–±—É—á–∞—é—â–∏–π üü¢", goal: 5, speed: 0.8, bubbles: 3 },
            { id: 2, name: "–°—Ç–∞–Ω–¥–∞—Ä—Ç üîµ", goal: 8, speed: 1.4, bubbles: 5 },
            { id: 3, name: "–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π üü£", goal: 10, speed: 2.2, bubbles: 6 },
            { id: 4, name: "–ú–∞—Å—Ç–µ—Ä üî¥", goal: 12, speed: 3.2, bubbles: 8 }
        ];

        const words = [
            { sing: "Goose", plur: "Geese" },
            { sing: "Mouse", plur: "Mice" },
            { sing: "Sheep", plur: "Sheep" },
            { sing: "Deer", plur: "Deer" },
            { sing: "Fish", plur: "Fish" },
            { sing: "Man", plur: "Men" },
            { sing: "Woman", plur: "Women" }
        ];

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        let config = { theme: 'underwater', mode: 'tap', customImg: '' };
        let gameState = { level: 0, score: 0, active: false, bubbles: [], target: null };

        // SOUND GENERATOR
        function playSfx(type) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);

            if (type === 'tap') {
                // Bubble pop sound
                osc.type = 'sine';
                osc.frequency.setValueAtTime(200, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(800, audioCtx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.2);
            } else if (type === 'shoot') {
                // Pistol shot sound
                osc.type = 'square';
                osc.frequency.setValueAtTime(150, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(40, audioCtx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
                gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.1);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.1);
                
                // Add noise for the "crack"
                const noiseBuffer = audioCtx.createBuffer(1, audioCtx.sampleRate * 0.05, audioCtx.sampleRate);
                const output = noiseBuffer.getChannelData(0);
                for (let i = 0; i < noiseBuffer.length; i++) output[i] = Math.random() * 2 - 1;
                const noise = audioCtx.createBufferSource();
                noise.buffer = noiseBuffer;
                const noiseGain = audioCtx.createGain();
                noiseGain.gain.setValueAtTime(0.3, audioCtx.currentTime);
                noiseGain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.05);
                noise.connect(noiseGain);
                noiseGain.connect(audioCtx.destination);
                noise.start();
            } else if (type === 'error') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(100, audioCtx.currentTime);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.2);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.2);
            }
        }

        function setTheme(t) {
            config.theme = t;
            document.getElementById('preview-box').style.backgroundImage = themes[t].bg;
        }

        function updateMode() {
            const isShoot = document.getElementById('mode-toggle').checked;
            config.mode = isShoot ? 'shoot' : 'tap';
            document.getElementById('mode-label').innerText = isShoot ? "–†–µ–∂–∏–º: –®—É—Ç–µ—Ä üî´" : "–†–µ–∂–∏–º: –¢–∞–ø–∞–Ω–∏–µ ü´ß";
            document.getElementById('audio-desc').innerText = isShoot ? "–û–∑–≤—É—á–∫–∞ –≤—ã—Å—Ç—Ä–µ–ª" : "–ú—è–≥–∫–∞—è –æ–∑–≤—É—á–∫–∞";
        }

        function dismissInstruction() {
            audioCtx.resume(); // Unlock audio on interaction
            document.getElementById('instruction-modal').style.transform = 'scale(0)';
            document.getElementById('instruction-modal').style.opacity = '0';
            setTimeout(() => document.getElementById('instruction-modal').style.display = 'none', 500);
            
            const btn = document.getElementById('start-btn');
            btn.disabled = false;
            btn.classList.add('pulse');
            btn.style.opacity = '1';
            btn.style.cursor = 'pointer';
        }

        function startGame() {
            document.getElementById('editor-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            document.getElementById('game-bg').style.backgroundImage = themes[config.theme].bg;
            if (config.mode === 'shoot') document.body.classList.add('crosshair');
            
            gameState.level = 0;
            gameState.score = 0;
            gameState.active = true;
            nextRound();
            gameLoop();
        }

        function returnToEditor() {
            gameState.active = false;
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('editor-screen').classList.remove('hidden');
            document.body.classList.remove('crosshair');
            clearBubbles();
        }

        function speak(text) {
            window.speechSynthesis.cancel();
            const ut = new SpeechSynthesisUtterance(text);
            ut.lang = 'en-US';
            ut.rate = 0.85;
            window.speechSynthesis.speak(ut);
        }

        function nextRound() {
            clearBubbles();
            const currentLevel = levels[gameState.level];
            document.getElementById('level-num').innerText = currentLevel.id;
            document.getElementById('level-name').innerText = currentLevel.name;

            const wordPair = words[Math.floor(Math.random() * words.length)];
            const isPlural = Math.random() > 0.5;
            gameState.target = isPlural ? wordPair.plur : wordPair.sing;
            
            document.getElementById('target-word').innerText = gameState.target;
            speak(gameState.target);

            for(let i = 0; i < currentLevel.bubbles; i++) {
                createBubble(i === 0);
            }
        }

        function createBubble(isCorrect) {
            const currentLevel = levels[gameState.level];
            const size = 110 + Math.random() * 50;
            const el = document.createElement('div');
            el.className = 'bubble';
            el.style.width = size + 'px';
            el.style.height = size + 'px';

            const content = document.createElement('div');
            if (config.customImg) {
                const img = document.createElement('img');
                img.src = config.customImg;
                content.appendChild(img);
            } else {
                const items = themes[config.theme].items;
                content.innerText = items[Math.floor(Math.random() * items.length)];
                content.style.fontSize = (size * 0.5) + 'px';
            }
            
            if (isCorrect) {
                const label = document.createElement('span');
                label.innerText = gameState.target;
                label.className = 'absolute -bottom-4 bg-blue-600 px-3 py-1 rounded-full text-[10px] font-bold shadow-lg';
                el.appendChild(label);
            }

            el.appendChild(content);
            document.getElementById('bubbles-container').appendChild(el);

            const bubble = {
                el: el,
                x: Math.random() * (window.innerWidth - size),
                y: Math.random() * (window.innerHeight - size),
                vx: (Math.random() - 0.5) * currentLevel.speed * 6,
                vy: (Math.random() - 0.5) * currentLevel.speed * 6,
                size: size,
                isCorrect: isCorrect
            };

            el.onclick = (e) => {
                e.stopPropagation();
                handlePop(bubble);
            };
            gameState.bubbles.push(bubble);
        }

        function handlePop(b) {
            if (b.isCorrect) {
                playSfx(config.mode); // Play bubble or shoot sound
                gameState.score++;
                showToast("–í –¢–û–ß–ö–£! üéØ");
                
                b.el.style.transform = 'scale(1.8)';
                b.el.style.opacity = '0';
                
                updateProgress();
                
                setTimeout(() => {
                    if (gameState.score >= levels[gameState.level].goal) {
                        nextLevel();
                    } else {
                        nextRound();
                    }
                }, 300);
            } else {
                playSfx('error');
                showToast("–ú–ò–ú–û! ü§™", true);
                b.el.style.boxShadow = '0 0 30px rgba(251, 113, 133, 0.5)';
                setTimeout(() => b.el.style.boxShadow = 'none', 300);
            }
        }

        function updateProgress() {
            const currentLevel = levels[gameState.level];
            const percent = (gameState.score / currentLevel.goal) * 100;
            document.getElementById('game-score').innerText = gameState.score;
            document.getElementById('progress-bar').style.width = percent + '%';
            document.getElementById('progress-percent').innerText = Math.round(percent) + '%';
        }

        function nextLevel() {
            if (gameState.level < levels.length - 1) {
                gameState.level++;
                gameState.score = 0;
                showToast("–ù–û–í–´–ô –£–†–û–í–ï–ù–¨! üöÄ");
                updateProgress();
                nextRound();
            } else {
                showToast("–¢–´ –ß–ï–ú–ü–ò–û–ù! üèÜ");
                setTimeout(returnToEditor, 2000);
            }
        }

        function clearBubbles() {
            document.getElementById('bubbles-container').innerHTML = '';
            gameState.bubbles = [];
        }

        function showToast(text, isError = false) {
            const t = document.createElement('div');
            t.className = 'toast shadow-2xl';
            if (isError) t.style.background = 'var(--bad)';
            t.innerText = text;
            document.body.appendChild(t);
            setTimeout(() => t.remove(), 2000);
        }

        function gameLoop() {
            if (!gameState.active) return;

            gameState.bubbles.forEach(b => {
                b.x += b.vx;
                b.y += b.vy;

                if (b.x <= 0) { b.x = 0; b.vx *= -1; }
                if (b.x >= window.innerWidth - b.size) { b.x = window.innerWidth - b.size; b.vx *= -1; }
                if (b.y <= 0) { b.y = 0; b.vy *= -1; }
                if (b.y >= window.innerHeight - b.size) { b.y = window.innerHeight - b.size; b.vy *= -1; }

                b.el.style.left = b.x + 'px';
                b.el.style.top = b.y + 'px';
            });

            requestAnimationFrame(gameLoop);
        }

        document.getElementById('custom-img').oninput = (e) => {
            config.customImg = e.target.value;
        };

        setTheme('underwater');
    </script>
</body>
</html>
