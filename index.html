<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Plural Bubbles Editor</title>
  <style>
    :root{
      --font:'Segoe UI',Roboto,system-ui,sans-serif;
      --primary:#4f46e5;
      --accent:#ec4899;
      --good:#22c55e;
      --bad:#ef4444;
      --ui-bg:rgba(15,23,42,0.9);
      --text:#f8fafc;
    }
    body{
      margin:0; overflow:hidden;
      font-family:var(--font);
      background:#0f172a; color:var(--text);
      user-select:none;
    }
    /* Layers */
    #bg-layer{ position:fixed; inset:0; z-index:-2; background-size:cover; background-position:center; transition:background 0.5s; }
    #particles-layer{ position:fixed; inset:0; z-index:-1; pointer-events:none; }
    #game-ui{ position:fixed; inset:0; pointer-events:none; display:flex; flex-direction:column; justify-content:space-between; padding:16px; }
    
    /* Elements */
    .hud-top{ display:flex; justify-content:space-between; align-items:flex-start; pointer-events:auto; }
    .score-box{
      background:var(--ui-bg); padding:8px 16px; border-radius:12px;
      border:2px solid rgba(255,255,255,0.1);
      display:flex; flex-direction:column; gap:4px;
    }
    .score-val{ font-size:28px; font-weight:800; color:var(--good); }
    .hearts{ font-size:24px; letter-spacing:4px; color:var(--bad); }
    
    .btn{
      background:linear-gradient(180deg, #6366f1, #4f46e5);
      border:none; border-radius:12px; color:#fff;
      padding:10px 20px; font-weight:bold; cursor:pointer;
      box-shadow:0 4px 0 #3730a3; transition:transform 0.1s;
      pointer-events:auto;
    }
    .btn:active{ transform:translateY(2px); box-shadow:0 2px 0 #3730a3; }
    .btn-icon{ padding:10px; font-size:20px; }

    /* Editor Modal */
    .modal-overlay{
      position:fixed; inset:0; background:rgba(0,0,0,0.6);
      backdrop-filter:blur(4px); z-index:100;
      display:none; align-items:center; justify-content:center;
    }
    .modal-overlay.open{ display:flex; }
    .modal{
      background:#1e293b; width:min(500px, 90vw); max-height:90vh;
      border-radius:20px; border:1px solid rgba(255,255,255,0.1);
      box-shadow:0 20px 50px rgba(0,0,0,0.5);
      display:flex; flex-direction:column; overflow:hidden;
    }
    .modal-header{ padding:20px; border-bottom:1px solid rgba(255,255,255,0.1); display:flex; justify-content:space-between; align-items:center; }
    .modal-body{ padding:20px; overflow-y:auto; display:flex; flex-direction:column; gap:20px; }
    
    .setting-group{ display:flex; flex-direction:column; gap:8px; }
    .setting-label{ font-size:14px; color:#94a3b8; font-weight:600; text-transform:uppercase; }
    
    /* Background Grid */
    .bg-grid{ display:grid; grid-template-columns:repeat(3,1fr); gap:8px; }
    .bg-option{
      aspect-ratio:16/9; border-radius:8px; border:2px solid transparent;
      background-size:cover; background-color:#334155; cursor:pointer;
      position:relative; overflow:hidden;
    }
    .bg-option.active{ border-color:var(--good); box-shadow:0 0 0 2px var(--good); }
    .bg-option input{ position:absolute; inset:0; opacity:0; cursor:pointer; }
    .bg-label{ position:absolute; bottom:0; left:0; right:0; background:rgba(0,0,0,0.7); font-size:10px; padding:4px; text-align:center; }

    /* Toggles */
    .toggle-row{ display:flex; justify-content:space-between; align-items:center; background:#334155; padding:12px; border-radius:10px; }
    .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #0f172a; transition: .4s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--accent); }
    input:checked + .slider:before { transform: translateX(24px); }

    /* Start Screen */
    #start-screen{
      position:fixed; inset:0; z-index:50;
      background:rgba(15,23,42,0.95);
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      text-align:center; padding:20px;
    }
    .instruct-card{
      background:#fff; color:#0f172a;
      padding:30px; border-radius:20px; max-width:600px;
      box-shadow:0 20px 60px rgba(0,0,0,0.5);
      animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    @keyframes popIn{ from{transform:scale(0.8);opacity:0;} to{transform:scale(1);opacity:1;} }
    
    /* Bubbles */
    .bubble{
      position:absolute; width:100px; height:100px;
      display:flex; align-items:center; justify-content:center;
      cursor:pointer; transition:transform 0.1s;
      filter:drop-shadow(0 10px 20px rgba(0,0,0,0.3));
    }
    .bubble:active{ transform:scale(0.95); }
    .bubble-bg{
      position:absolute; inset:0; border-radius:50%;
      background:radial-gradient(circle at 30% 30%, rgba(255,255,255,0.2), rgba(255,255,255,0.05) 60%, rgba(255,255,255,0) 80%);
      border:2px solid rgba(255,255,255,0.3);
      box-shadow:inset 0 0 20px rgba(255,255,255,0.1);
    }
    .bubble img{ width:70%; height:70%; object-fit:contain; z-index:2; pointer-events:none; }

    /* Effects */
    .particle{ position:absolute; pointer-events:none; opacity:0.6; }
    .pop-effect{ position:absolute; pointer-events:none; animation:explode 0.4s forwards; }
    @keyframes explode{ 0%{transform:scale(1);opacity:1;} 100%{transform:scale(2);opacity:0;} }
  </style>
</head>
<body>

<!-- Layers -->
<div id="bg-layer" style="background-image: linear-gradient(to bottom, #0f172a, #1e293b);"></div>
<div id="particles-layer"></div>

<div id="game-ui">
  <div class="hud-top">
    <div class="score-box">
      <div class="score-val" id="ui-score">0</div>
      <div class="hearts" id="ui-hearts">‚ù§‚ù§‚ù§</div>
    </div>
    <div style="display:flex; gap:10px;">
      <button class="btn btn-icon" onclick="toggleEditor()">‚öô</button>
      <button class="btn btn-icon" id="btn-sound">üîä</button>
    </div>
  </div>
  <div class="hud-center" id="subtitle-box" style="text-align:center; padding-bottom:40px;">
    <div style="font-size:24px; font-weight:bold; text-shadow:0 2px 10px #000;" id="ui-target">...</div>
  </div>
</div>

<div id="field"></div>

<!-- Start Screen -->
<div id="start-screen">
  <div class="instruct-card">
    <h1 style="margin:0 0 10px; color:#4f46e5;">Plural Bubbles</h1>
    <p style="font-size:18px; line-height:1.5;">
      –ü—Ä–∏–≤–µ—Ç! üëã <br>
      –í —ç—Ç–æ–π –∏–≥—Ä–µ –Ω—É–∂–Ω–æ –ª–æ–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—É–∑—ã—Ä–∏.<br>
      1. –°–ª—É—à–∞–π —Å–ª–æ–≤–æ –∏–ª–∏ —Ñ—Ä–∞–∑—É.<br>
      2. –ù–∞—Ö–æ–¥–∏ –Ω—É–∂–Ω—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É.<br>
      3. –õ–û–ü–ê–ô –ø—É–∑—ã—Ä—å! üí•
    </p>
    <div style="margin:20px 0; background:#f1f5f9; padding:15px; border-radius:10px;">
      üéØ –¶–µ–ª—å: –°–æ–±—Ä–∞—Ç—å 10 –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤.<br>
      ‚ù§ –ñ–∏–∑–Ω–∏: –£ —Ç–µ–±—è 3 –ø–æ–ø—ã—Ç–∫–∏.
    </div>
    <button class="btn" style="font-size:20px; padding:12px 30px;" onclick="startGame()">START GAME ‚ñ∂</button>
  </div>
</div>

<!-- Editor Modal -->
<div class="modal-overlay" id="editor-modal">
  <div class="modal">
    <div class="modal-header">
      <h3 style="margin:0;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ò–≥—Ä—ã</h3>
      <button class="btn btn-icon" style="padding:5px 10px; font-size:16px;" onclick="toggleEditor()">‚úï</button>
    </div>
    <div class="modal-body">
      
      <!-- Backgrounds -->
      <div class="setting-group">
        <div class="setting-label">–§–æ–Ω</div>
        <div class="bg-grid">
          <div class="bg-option" onclick="setBg('underwater')" style="background-image:url('assets/bg_underwater.jpg')"><span class="bg-label">–í–æ–¥–∞</span></div>
          <div class="bg-option" onclick="setBg('forest')" style="background-image:url('assets/bg_forest.jpg')"><span class="bg-label">–õ–µ—Å</span></div>
          <div class="bg-option" onclick="setBg('space')" style="background-image:url('assets/bg_space.jpg')"><span class="bg-label">–ö–æ—Å–º–æ—Å</span></div>
          <div class="bg-option" onclick="setBg('sunset')" style="background-image:url('assets/bg_sunset.jpg')"><span class="bg-label">–í–µ—á–µ—Ä</span></div>
          <div class="bg-option" onclick="setBg('park')" style="background-image:url('assets/bg_park.jpg')"><span class="bg-label">–ü–∞—Ä–∫</span></div>
          <div class="bg-option" style="border:2px dashed #64748b; display:flex; align-items:center; justify-content:center;">
            <span style="font-size:24px; color:#64748b;">+</span>
            <input type="file" accept="image/*" onchange="uploadBg(this)">
            <span class="bg-label">–°–≤–æ–π</span>
          </div>
        </div>
      </div>

      <!-- Mode -->
      <div class="setting-group">
        <div class="setting-label">–†–µ–∂–∏–º –∏–≥—Ä—ã</div>
        <div class="toggle-row">
          <div>
            <div style="font-weight:bold;">Shooter Mode üî´</div>
            <div style="font-size:12px; color:#94a3b8;">–ê–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π –∑–≤—É–∫ –∏ –≤–∑—Ä—ã–≤—ã</div>
          </div>
          <label class="switch">
            <input type="checkbox" id="mode-switch" onchange="updateSettings()">
            <span class="slider"></span>
          </label>
        </div>
      </div>
      
      <!-- Particles -->
      <div class="setting-group">
        <div class="setting-label">–õ–µ—Ç–∞—é—â–∏–µ —á–∞—Å—Ç–∏—Ü—ã</div>
        <div class="toggle-row">
          <div>
            <div style="font-weight:bold;">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–≤–æ—ë</div>
            <div style="font-size:12px; color:#94a3b8;">PNG –æ–±—ä–µ–∫—Ç (—Å–Ω–µ–∂–∏–Ω–∫–∞, –ª–∏—Å—Ç)</div>
          </div>
          <input type="file" accept="image/*" onchange="uploadParticle(this)" style="width:100px; font-size:12px;">
        </div>
      </div>

    </div>
  </div>
</div>

<script>
// ================= DATA =================
const ASSET = p => `assets/${p}`;
const DATA = [
  { key:"goose", s:"goose", p:"geese", i1:ASSET("goose_1.png"), i3:ASSET("geese_3.png") },
  { key:"sheep", s:"sheep", p:"sheep", i1:ASSET("sheep_1.png"), i3:ASSET("sheep_3.png") },
  { key:"deer",  s:"deer",  p:"deer",  i1:ASSET("deer_1.png"),  i3:ASSET("deer_3.png") },
  { key:"fish",  s:"fish",  p:"fish",  i1:ASSET("fish_1.png"),  i3:ASSET("fish_3.png") },
  { key:"mouse", s:"mouse", p:"mice",  i1:ASSET("mouse_1.png"), i3:ASSET("mice_3.png") },
  { key:"man",   s:"man",   p:"men",   i1:ASSET("man_1.png"),   i3:ASSET("men_3.png") },
  { key:"woman", s:"woman", p:"women", i1:ASSET("woman_1.png"), i3:ASSET("women_3.png") },
];

// ================= STATE =================
let state = {
  score: 0,
  hearts: 3,
  isPlaying: false,
  mode: 'tap', // 'tap' or 'shooter'
  bg: 'underwater',
  particleImg: null, // null = auto
  bubbles: [],
  target: null
};

// ================= AUDIO =================
// Simple synth for effects (no external files needed for logic)
const AudioCtx = window.AudioContext || window.webkitAudioContext;
let actx = new AudioCtx();

function playSound(type){
  if(actx.state === 'suspended') actx.resume();
  const osc = actx.createOscillator();
  const gain = actx.createGain();
  osc.connect(gain);
  gain.connect(actx.destination);
  
  const now = actx.currentTime;
  
  if(type === 'pop-soft'){ // Bubbles tap
    osc.type = 'sine';
    osc.frequency.setValueAtTime(400, now);
    osc.frequency.exponentialRampToValueAtTime(600, now+0.1);
    gain.gain.setValueAtTime(0.5, now);
    gain.gain.exponentialRampToValueAtTime(0.01, now+0.1);
    osc.start(now); osc.stop(now+0.15);
  }
  else if(type === 'pop-hard'){ // Shooter explosion
    osc.type = 'sawtooth';
    osc.frequency.setValueAtTime(100, now);
    osc.frequency.exponentialRampToValueAtTime(50, now+0.2);
    gain.gain.setValueAtTime(0.5, now);
    gain.gain.exponentialRampToValueAtTime(0.01, now+0.2);
    osc.start(now); osc.stop(now+0.25);
  }
  else if(type === 'win'){
    osc.type = 'triangle';
    osc.frequency.setValueAtTime(400, now);
    osc.frequency.linearRampToValueAtTime(800, now+0.3);
    gain.gain.setValueAtTime(0.3, now);
    gain.gain.linearRampToValueAtTime(0, now+0.5);
    osc.start(now); osc.stop(now+0.5);
  }
  else if(type === 'lose'){
    osc.type = 'square';
    osc.frequency.setValueAtTime(150, now);
    osc.frequency.linearRampToValueAtTime(100, now+0.3);
    gain.gain.setValueAtTime(0.3, now);
    gain.gain.linearRampToValueAtTime(0, now+0.4);
    osc.start(now); osc.stop(now+0.4);
  }
}

function speak(text){
  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.lang = 'en-US'; u.rate = 0.9;
  window.speechSynthesis.speak(u);
}

// ================= GAME LOGIC =================
function startGame(){
  document.getElementById('start-screen').style.display = 'none';
  state.isPlaying = true;
  state.score = 0;
  state.hearts = 3;
  updateHud();
  startRound();
  initParticles();
}

function startRound(){
  // Clear old
  document.getElementById('field').innerHTML = '';
  state.bubbles = [];
  
  // Pick target
  const item = DATA[Math.floor(Math.random()*DATA.length)];
  const form = Math.random() > 0.5 ? 'p' : 's';
  const word = form==='p' ? item.p : item.s;
  const targetImg = form==='p' ? item.i3 : item.i1;
  const phrase = `Find: ${word}`;
  
  state.target = { word, img: targetImg };
  
  // UI
  document.getElementById('ui-target').innerText = phrase;
  document.getElementById('ui-target').style.animation = 'none';
  void document.getElementById('ui-target').offsetWidth;
  document.getElementById('ui-target').style.animation = 'popIn 0.5s';
  speak(word); // Auto speak
  
  // Spawn Bubbles (1 Correct + 5 Distractors)
  let pool = [];
  pool.push({ img:targetImg, correct:true });
  
  for(let i=0; i<5; i++){
    const rndItem = DATA[Math.floor(Math.random()*DATA.length)];
    const rndForm = Math.random() > 0.5 ? 'p' : 's';
    const img = rndForm==='p' ? rndItem.i3 : rndItem.i1;
    // Simple check to avoid duplicate correct image
    if(img !== targetImg) pool.push({ img:img, correct:false });
    else i--; // retry
  }
  pool.sort(()=>Math.random()-0.5);
  
  pool.forEach(p => createBubble(p));
}

function createBubble(data){
  const el = document.createElement('div');
  el.className = 'bubble';
  el.innerHTML = `<div class="bubble-bg"></div><img src="${data.img}">`;
  
  // Random Position & Speed
  let x = Math.random() * (window.innerWidth - 100);
  let y = Math.random() * (window.innerHeight - 200) + 100;
  let vx = (Math.random()-0.5) * 2;
  let vy = (Math.random()-0.5) * 2;
  
  el.style.left = x+'px';
  el.style.top = y+'px';
  
  el.onpointerdown = (e) => {
    e.stopPropagation();
    hitBubble(el, data.correct);
  };
  
  document.getElementById('field').appendChild(el);
  state.bubbles.push({ el, x, y, vx, vy });
}

function hitBubble(el, isCorrect){
  if(isCorrect){
    // Win logic
    playSound(state.mode === 'shooter' ? 'pop-hard' : 'pop-soft');
    createExplosion(el.offsetLeft+50, el.offsetTop+50, true);
    state.score++;
    updateHud();
    el.remove();
    setTimeout(startRound, 500);
  } else {
    // Lose logic
    playSound('lose');
    state.hearts--;
    updateHud();
    el.style.filter = 'grayscale(1) brightness(0.5)';
    createExplosion(el.offsetLeft+50, el.offsetTop+50, false);
    
    if(state.hearts <= 0) gameOver();
  }
}

function createExplosion(x, y, success){
  const div = document.createElement('div');
  div.className = 'pop-effect';
  div.style.left = (x-50)+'px';
  div.style.top = (y-50)+'px';
  div.style.width = '100px';
  div.style.height = '100px';
  div.style.background = success 
    ? (state.mode === 'shooter' ? 'radial-gradient(circle, #fbbf24, transparent)' : 'radial-gradient(circle, #a5f3fc, transparent)')
    : 'radial-gradient(circle, #ef4444, transparent)';
  div.style.borderRadius = '50%';
  document.body.appendChild(div);
  setTimeout(()=>div.remove(), 500);
}

function gameOver(){
  state.isPlaying = false;
  document.querySelector('.instruct-card h1').innerText = "Game Over!";
  document.querySelector('.instruct-card p').innerText = `–¢–≤–æ–π —Å—á–µ—Ç: ${state.score}`;
  document.getElementById('start-screen').style.display = 'flex';
}

function updateHud(){
  document.getElementById('ui-score').innerText = state.score;
  document.getElementById('ui-hearts').innerText = '‚ù§'.repeat(state.hearts);
}

// ================= LOOP & PARTICLES =================
function loop(){
  if(!state.isPlaying) { requestAnimationFrame(loop); return; }
  
  state.bubbles.forEach(b => {
    b.x += b.vx;
    b.y += b.vy;
    
    // Bounce
    if(b.x < 0 || b.x > window.innerWidth-100) b.vx *= -1;
    if(b.y < 50 || b.y > window.innerHeight-100) b.vy *= -1;
    
    b.el.style.transform = `translate(${b.x}px, ${b.y}px)`;
  });
  
  requestAnimationFrame(loop);
}
loop();

function initParticles(){
  const layer = document.getElementById('particles-layer');
  layer.innerHTML = '';
  // Determine particle type based on bg
  let type = 'circle';
  let color = 'rgba(255,255,255,0.2)';
  
  if(state.bg === 'underwater') type = 'bubble';
  if(state.bg === 'forest') { type = 'firefly'; color='#fef08a'; }
  if(state.bg === 'space') { type = 'star'; }
  
  for(let i=0; i<20; i++){
    const p = document.createElement('div');
    p.className = 'particle';
    let size = Math.random()*10 + 5;
    
    p.style.width = size+'px';
    p.style.height = size+'px';
    p.style.left = Math.random()*100 + 'vw';
    p.style.top = Math.random()*100 + 'vh';
    
    if(state.particleImg){
      p.style.backgroundImage = `url(${state.particleImg})`;
      p.style.backgroundSize = 'contain';
    } else {
      p.style.background = color;
      p.style.borderRadius = '50%';
      if(type === 'star') p.style.clipPath = 'polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%)';
    }
    
    // CSS Animation for movement
    let dur = Math.random()*10 + 5;
    p.style.transition = `top ${dur}s linear, opacity 2s`;
    
    layer.appendChild(p);
    
    // Simple reset loop for CSS
    setInterval(()=>{
      p.style.top = '-10px';
      setTimeout(()=>{ 
        p.style.transition = 'none'; 
        p.style.top = '110vh'; 
        setTimeout(()=>{ p.style.transition = `top ${dur}s linear`; },100);
      }, dur*1000);
    }, Math.random()*5000);
  }
}

// ================= EDITOR FUNCTIONS =================
function toggleEditor(){
  const el = document.getElementById('editor-modal');
  el.classList.toggle('open');
}

function setBg(name){
  state.bg = name;
  const bgEl = document.getElementById('bg-layer');
  if(name==='underwater') bgEl.style.backgroundImage = `url('assets/bg_underwater.jpg')`;
  if(name==='forest') bgEl.style.backgroundImage = `url('assets/bg_forest.jpg')`;
  if(name==='space') bgEl.style.backgroundImage = `url('assets/bg_space.jpg')`;
  if(name==='sunset') bgEl.style.backgroundImage = `url('assets/bg_sunset.jpg')`;
  if(name==='park') bgEl.style.backgroundImage = `url('assets/bg_park.jpg')`;
  
  initParticles(); // refresh particles
}

function uploadBg(input){
  if(input.files && input.files[0]){
    const reader = new FileReader();
    reader.onload = function(e){
      document.getElementById('bg-layer').style.backgroundImage = `url(${e.target.result})`;
    }
    reader.readAsDataURL(input.files[0]);
  }
}

function uploadParticle(input){
  if(input.files && input.files[0]){
    const reader = new FileReader();
    reader.onload = function(e){
      state.particleImg = e.target.result;
      initParticles();
    }
    reader.readAsDataURL(input.files[0]);
  }
}

function updateSettings(){
  const isShooter = document.getElementById('mode-switch').checked;
  state.mode = isShooter ? 'shooter' : 'tap';
}

document.getElementById('btn-sound').onclick = () => { speak(state.target.word); }

</script>
</body>
</html>
